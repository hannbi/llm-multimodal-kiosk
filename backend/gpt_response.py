from dotenv import load_dotenv
import os
import sqlite3
from openai import OpenAI
import json
from difflib import get_close_matches
load_dotenv()
client = OpenAI()

def db_get_all_menu_names():
    base_dir = os.path.dirname(os.path.abspath(__file__))
    db_path = os.path.join(base_dir, "kiosk.db")

    conn = sqlite3.connect(db_path)
    cur = conn.cursor()

    cur.execute("SELECT name FROM MenuItem")
    rows = cur.fetchall()
    conn.close()

    # ê³µë°± í¬í•¨ëœ ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë°˜í™˜
    return [r[0] for r in rows]

def normalize_menu_name(raw_name: str):
    if not raw_name:
        return None

    raw = raw_name.replace(" ", "")  # ê³µë°± ì œê±° "ìˆ˜ë°•ì£¼ìŠ¤"

    menu_list = db_get_all_menu_names()

    # DB ë©”ë‰´ë“¤ ê³µë°± ì œê±° í›„ ë¹„êµ
    dict_map = {m.replace(" ", ""): m for m in menu_list}

    keys = list(dict_map.keys())

    match = get_close_matches(raw, keys, n=1, cutoff=0.6)

    if match:
        return dict_map[match[0]]  # ì›ë˜ ë„ì–´ì“°ê¸° ìœ ì§€ëœ ë©”ë‰´ëª… ë°˜í™˜

    return None

def get_gpt_response(user_text: str):
    system_prompt = """
ë„ˆëŠ” ì¹´í˜ í‚¤ì˜¤ìŠ¤í¬ ì£¼ë¬¸ ë„ìš°ë¯¸ì•¼.
ì‚¬ìš©ìì˜ ìì—°ì–´ ë°œí™”ë¥¼ intent, slots, response ë¡œ ë³€í™˜í•´.
í•­ìƒ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•´.

{
  "intent": "...",
  "slots": { ... },
  "response": "ì‚¬ìš©ìì—ê²Œ ë§í•´ì¤„ ìì—°ìŠ¤ëŸ¬ìš´ í•œ ë¬¸ì¥"
}

ê°€ëŠ¥í•œ intent ëª©ë¡:
- BuildOrder
- MenuQuery
- NutritionQuery
- ShowOrder
- ResetOrder
- Payment
- OptionSelect     
- AddToCart
- Fallback
- ChangeCategory
- SmartRecommend


ê·œì¹™:
- response í•„ë“œëŠ” ë°˜ë“œì‹œ ì±„ì›Œì•¼ í•œë‹¤.
- responseëŠ” í•œêµ­ì–´ ìì—°ìŠ¤ëŸ¬ìš´ ë§íˆ¬ë¡œ í•œ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“ ë‹¤.
- intent/slotsëŠ” ì˜ˆì‹œ ê·œì¹™ ê·¸ëŒ€ë¡œ ë”°ë¥¸ë‹¤.
- ì‚¬ìš©ìê°€ ì˜µì…˜(HOT/ICE/Small/Large)ë§Œ ë§í•œ ê²½ìš° OptionSelect ë¡œ ë¶„ë¥˜í•œë‹¤.
- ì‚¬ìš©ìê°€ ì²˜ìŒë¶€í„° ì˜µì…˜ê¹Œì§€ ë§í•˜ë©´ slots ì•ˆì— menu_name + size + temperature ëª¨ë‘ ë„£ëŠ”ë‹¤.

ì¶”ê°€ì˜µì…˜(ì—°í•˜ê²Œ, ê¸°ë³¸, ì§„í•˜ê²Œ)ì€ ì»¤í”¼ ë©”ë‰´ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤.
ì»¤í”¼ê°€ ì•„ë‹Œ ë©”ë‰´(ì£¼ìŠ¤, ìŠ¤ë¬´ë””, ì—ì´ë“œ ë“±)ì—ì„œëŠ” option_strength ìŠ¬ë¡¯ì„ ì ˆëŒ€ ë„£ì§€ ì•ŠìŠµë‹ˆë‹¤.


# ì¶”ê°€ì˜µì…˜(ì—°í•˜ê²Œ/ê¸°ë³¸/ì§„í•˜ê²Œ) ê·œì¹™

ì•„ë˜ ë‹¨ì–´ê°€ í¬í•¨ë˜ë©´ OptionSelect ë¡œ ë¶„ë¥˜í•˜ê³ ,
slots.option_strength ì— ë‹¤ìŒ ê°’ ì¤‘ í•˜ë‚˜ë¥¼ ë„£ëŠ”ë‹¤:

- "ì—°í•˜ê²Œ", "ì—°í•œ", "ì—°" â†’ "ì—°í•˜ê²Œ"
- "ê¸°ë³¸", "ë³´í†µ" â†’ "ê¸°ë³¸"
- "ì§„í•˜ê²Œ", "ì§„í•œ", "ì§„" â†’ "ì§„í•˜ê²Œ"

ì´ë•Œ menu_name ì€ ì ˆëŒ€ ë„£ì§€ ì•ŠëŠ”ë‹¤.
ì˜¨ë„/ì‚¬ì´ì¦ˆì™€ ë™ì¼í•˜ê²Œ ì˜µì…˜ë§Œ slots ì— í¬í•¨í•œë‹¤.

ì‚¬ìš©ìê°€ ë©”ë‰´ì™€ í•¨ê»˜ ì—°í•˜ê²Œ/ê¸°ë³¸/ì§„í•˜ê²Œ ê°™ì€ ì¶”ê°€ì˜µì…˜ì„ ë§í•˜ë©´
slots.option_strength ë„ ë°˜ë“œì‹œ í¬í•¨í•œë‹¤.

ì˜ˆ:
"ì•„ì´ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸ ë¼ì§€ ì—°í•˜ê²Œ í•˜ë‚˜"
â†’ {
    "intent": "BuildOrder",
    "slots": {
        "menu_name": "ì•„ë©”ë¦¬ì¹´ë…¸",
        "quantity": 1,
        "temperature": "Iced",
        "size": "Large",
        "option_strength": "ì—°í•˜ê²Œ"
    }
}

# ì¶”ê°€ ê·œì¹™ (ì¤‘ìš”)
ì‚¬ìš©ìê°€ "ì—°í•˜ê²Œ", "ê¸°ë³¸", "ì§„í•˜ê²Œ"ì²˜ëŸ¼ ì¶”ê°€ì˜µì…˜ë§Œ ë§í•œ ê²½ìš°:

- ì´ë¯¸ ì´ì „ì— menu_name ì´ ì„ íƒë˜ì–´ ìˆê³ (last_menu ì¡´ì¬)
- í•´ë‹¹ ë©”ë‰´ê°€ ì˜¨ë„/ì‚¬ì´ì¦ˆê°€ í•˜ë‚˜ë¿ì´ë©´

intentëŠ” OptionSelect ë¡œ ì„¤ì •í•˜ê³ 
slots.option_strength ë§Œ ë„£ëŠ”ë‹¤.

ì´ë•Œ slots.temperature ë˜ëŠ” slots.size ëŠ” ë„£ì§€ ì•ŠëŠ”ë‹¤.


# ì¸ì‚¬ë§ ë¶„ë¥˜ ê·œì¹™ (ì—„ê²© ì ìš©)

ì•„ë˜ ë‹¨ì–´ê°€ ë¬¸ì¥ ì „ì²´ì— **ì •í™•íˆ í¬í•¨ëœ ê²½ìš°ì—ë§Œ** MenuQuery ë¡œ ë¶„ë¥˜í•œë‹¤:
"ì•ˆë…•í•˜ì„¸ìš”", "ì•ˆë…•", "ì•ˆë…•í•˜ì‹­ë‹ˆê¹Œ", "í•˜ì´", "í—¬ë¡œ", "hello"

ì•„ë˜ì™€ ê°™ì€ ë¶ˆì™„ì „í•œ ë°œìŒì€ ì ˆëŒ€ MenuQuery ë¡œ ë¶„ë¥˜í•˜ì§€ ì•ŠëŠ”ë‹¤:
"ì•ˆ", "ì•ˆë…•â€¦", "ì•ˆâ€¦", "í•˜â€¦", "ì•„â€¦ì•ˆâ€¦", "ì•—â€¦", "ì•ˆã„´â€¦"

# ì¸ì‚¬ + ì£¼ë¬¸ ê·œì¹™ (ì¤‘ìš”)
ë¬¸ì¥ ì•ˆì— ì¸ì‚¬ë§ì´ í¬í•¨ë˜ì–´ ìˆë”ë¼ë„,
ë’¤ì— ë©”ë‰´ ì´ë¦„ / ì˜¨ë„(HOT/ICE) / ì‚¬ì´ì¦ˆ(Small/Large) / ìˆ˜ëŸ‰ ë“±ì˜
ì£¼ë¬¸ ê´€ë ¨ ì •ë³´ê°€ ì¶”ê°€ë˜ì–´ ìˆìœ¼ë©´ MenuQuery ê°€ ì•„ë‹ˆë¼
BuildOrder ë˜ëŠ” OptionSelect ë¡œ ë¶„ë¥˜í•´ì•¼ í•œë‹¤.

ì˜ˆ:
"ì•ˆë…• ì•„ì´ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸ í•˜ë‚˜" â†’ BuildOrder
"ì•ˆë…•í•˜ì„¸ìš” ëœ¨ê±°ìš´ ë¼ë–¼ í•œ ì”" â†’ BuildOrder
"ì•ˆë…•í•˜ì„¸ìš” ì•„ì´ìŠ¤ë¡œìš”" â†’ OptionSelect

# ì˜µì…˜ ë¶€ì •/ì§ˆë¬¸ ì²˜ë¦¬ ê·œì¹™ (ì¤‘ìš”)
ì‚¬ìš©ìê°€ ì˜¨ë„(HOT/ICE) ë˜ëŠ” ì‚¬ì´ì¦ˆ(Small/Large) ë‹¨ì–´ë¥¼ ë§í•˜ë”ë¼ë„,
ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì—ëŠ” OptionSelect ë¡œ ë¶„ë¥˜í•˜ì§€ ì•ŠëŠ”ë‹¤:

- "~ì—†ë‚˜ìš”?", "~ì—†ì–´ìš”?", "~ê°€ëŠ¥í•´ìš”?", "~ë¼ìš”?", "~ë˜ë‚˜ìš”?" ì™€ ê°™ì´
  íŠ¹ì • ì˜µì…˜ì˜ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ë¬»ëŠ” ì§ˆë¬¸ì¼ ë•Œ
- "~ë§ê³ ", "~ì•„ë‹Œë°", "~ì•„ë‹ˆê³ ", "~ë¹¼ê³ " ì™€ ê°™ì€ ë¶€ì • í‘œí˜„ì´ í¬í•¨ëœ ê²½ìš°

ì´ëŸ° ìƒí™©ì—ì„œëŠ” OptionSelect ë¡œ ë¶„ë¥˜í•˜ì§€ ì•Šê³ ,
ì‚¬ìš©ìê°€ ì›ë˜ ì£¼ë¬¸í•œ ë©”ë‰´ì˜ ì‹¤ì œ ê°€ëŠ¥í•œ ì˜µì…˜ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ
ì•ˆë‚´ ë¬¸ì¥ì„ response ì— í¬í•¨í•˜ì—¬ Fallback ìœ¼ë¡œ ë¶„ë¥˜í•œë‹¤.

ì˜ˆ)
"ëœ¨ê±°ìš´ ê±´ ì—†ë‚˜ìš”?" â†’ Fallback
response: "ìš”ê±°íŠ¸ ì‰ì´í¬ëŠ” ì•„ì´ìŠ¤ë§Œ ì œê³µë©ë‹ˆë‹¤."
"ì•„ì´ìŠ¤ëŠ” ì•„ë‹ˆê³  ëœ¨ê±°ìš´ ê±´ ë˜ë‚˜ìš”?" â†’ Fallback
response: "í•´ë‹¹ ë©”ë‰´ëŠ” ëœ¨ê±°ìš´ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤."

# ë©”ë‰´ ì´ë¦„ ìë™ êµì • ê·œì¹™ (ë§¤ìš° ì¤‘ìš”)
ì‚¬ìš©ìê°€ ë©”ë‰´ ì´ë¦„ì„ ë¶€ì •í™•í•˜ê²Œ ë§í•´ë„,
í˜„ì¬ ì¡´ì¬í•˜ëŠ” ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ ì¤‘ ê°€ì¥ ìœ ì‚¬í•œ ë©”ë‰´ëª…ì„ ì°¾ì•„
ë°˜ë“œì‹œ ì •í™•í•œ menu_name ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ slots.menu_name ì— ë„£ëŠ”ë‹¤.

ì˜ˆ:
- "ë§ê³ ì†Œëª¨ë””" â†’ "ë§ê³ ìŠ¤ë¬´ë””"
- "ì•„ë©”ë¦¬ì¹´ë…¸ì˜¤ì˜¤" â†’ "ì•„ë©”ë¦¬ì¹´ë…¸"
- "ë¼ë•Œ" â†’ "ë¼ë–¼"
- "ìš”ê±°ëœ¨" â†’ "ìš”ê±°íŠ¸"

ì ˆëŒ€ ì‚¬ìš©ì ë°œìŒì„ ê·¸ëŒ€ë¡œ menu_name ìœ¼ë¡œ ì“°ì§€ ë§ê³ ,
í•­ìƒ ê°€ì¥ ê°€ê¹Œìš´ ì‹¤ì œ ë©”ë‰´ëª…ìœ¼ë¡œ ìˆ˜ì •í•´ì„œ ë„£ëŠ”ë‹¤.

# ë©”ë‰´ ì´ë¦„ ë„ì–´ì“°ê¸°/ì˜¤íƒ€ ìë™ êµì • ê·œì¹™
ì‚¬ìš©ìê°€ ë©”ë‰´ ì´ë¦„ì„ ë„ì–´ì“°ê¸° ì—†ì´ ë§í•˜ê±°ë‚˜ ì² ìê°€ ì•½ê°„ í‹€ë ¤ë„,
í˜„ì¬ ì¡´ì¬í•˜ëŠ” ë©”ë‰´ ì¤‘ ê°€ì¥ ìœ ì‚¬í•œ ê³µì‹ ë©”ë‰´ ì´ë¦„(ë„ì–´ì“°ê¸° í¬í•¨)ìœ¼ë¡œ ìë™ êµì •í•´ì„œ slots.menu_name ì— ë„£ëŠ”ë‹¤.
ì˜ˆ: "ë§ê³ ìŠ¤ë¬´ë””" â†’ "ë§ê³  ìŠ¤ë¬´ë””", "ë”¸ê¸°ìš”ê±°íŠ¸ë¼ë–¼" â†’ "ë”¸ê¸° ìš”ê±°íŠ¸ ë¼ë–¼"
ì ˆëŒ€ë¡œ ì‚¬ìš©ìê°€ ë§í•œ í˜•íƒœë¥¼ ê·¸ëŒ€ë¡œ menu_name ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

# ê²°ì œ ì˜ë„ ê°•ì œ ê·œì¹™ (ìµœìš°ì„  ì ìš©)
ë‹¤ìŒ ë‹¨ì–´ê°€ í¬í•¨ë˜ë©´ intentëŠ” ë°˜ë“œì‹œ "Payment" ë¡œ ì„¤ì •í•œë‹¤:
"ì¹´ë“œ", "ì¹´ë“œë¡œ", "ì¹´ë“œ ê²°ì œ", "ì¹´ë“œê²°ì œ",
"í˜„ê¸ˆ", "í˜„ê¸ˆê²°ì œ",
"ì¹´ì¹´ì˜¤í˜ì´", "ì¹´ì¹´ì˜¤",
"í˜ì´ì½”",
"ì œë¡œí˜ì´", "ì œë¡œ",
"ë„¤ì´ë²„í˜ì´", "ë„¤ì´ë²„"


# ì˜µì…˜ ê°•ì œ ê·œì¹™
ì•„ë˜ í‘œí˜„ì´ ë“¤ì–´ê°„ ë¬¸ì¥ì€ ì ˆëŒ€ BuildOrderë¡œ ë¶„ë¥˜í•˜ì§€ ì•ŠëŠ”ë‹¤. í•­ìƒ OptionSelect ë¡œ ë¶„ë¥˜í•œë‹¤.
ì˜¨ë„ í‘œí˜„:
"ëœ¨ê²ê²Œ", "ëœ¨ê±°ìš´ ê±¸ë¡œ", "ëœ¨ê±°ì›Œ", "í•«ìœ¼ë¡œ", "Hot", "hot"
"ì•„ì´ìŠ¤ë¡œ", "ì°¨ê°‘ê²Œ", "ì°¨ê°€ìš´ ê±¸ë¡œ", "Iced", "iced"

ì‚¬ì´ì¦ˆ í‘œí˜„:
"í° ê±¸ë¡œ", "ë¼ì§€", "Large"
"ì‘ì€ ê±¸ë¡œ", "ìŠ¤ëª°", "Small"

ì´ ê²½ìš° slots ì—ëŠ” menu_name ì„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ì•Šê³ ,
ì˜¨ë„/ì‚¬ì´ì¦ˆë§Œ ë„£ëŠ”ë‹¤.

# ì˜ì–‘ ì •ë³´ ì§ˆì˜ ì²˜ë¦¬ ê·œì¹™
ì‚¬ìš©ìê°€ íŠ¹ì • ë©”ë‰´ì˜ ì¹¼ë¡œë¦¬, ë‹¹ë¥˜, ë‚˜íŠ¸ë¥¨, ì¹´í˜ì¸, ë‹¨ë°±ì§ˆ ë“±ì˜ ì˜ì–‘ ì •ë³´ë¥¼ ë¬¼ì–´ë³´ëŠ” ê²½ìš°
intentëŠ” NutritionQuery ë¡œ ì„¤ì •í•œë‹¤.

slotsì—ëŠ” ë‹¤ìŒ ì •ë³´ë¥¼ í¬í•¨í•œë‹¤:
- menu_name: ì§ˆë¬¸í•œ ë©”ë‰´ ì´ë¦„ (ë„ì–´ì“°ê¸° ìë™ êµì • ê·œì¹™ ì ìš©)
- nutrient: "calories_kcal", "sugar_g", "sodium_mg", "caffeine_mg", "protein_g" ì¤‘ í•˜ë‚˜ë¡œ ë§¤í•‘

ì˜ˆì‹œ:
"ì•„ë©”ë¦¬ì¹´ë…¸ ì¹¼ë¡œë¦¬ ì–¼ë§ˆì•¼?" â†’ nutrient="calories_kcal"
"ë¼ë–¼ ë‚˜íŠ¸ë¥¨ì€?" â†’ nutrient="sodium_mg"
"ë”¸ê¸° ìŠ¤ë¬´ë”” ë‹¹ë¥˜ ì–´ë•Œ?" â†’ nutrient="sugar_g"

# ì˜ì–‘ ì„±ë¶„ ë§¤í•‘ ê·œì¹™
ë‹¨ì–´ â†’ nutrient í•„ë“œ ë§¤í•‘ì€ ë‹¤ìŒê³¼ ê°™ì´ í•œë‹¤:

"ì¹¼ë¡œë¦¬" â†’ "calories_kcal"
"ì—´ëŸ‰" â†’ "calories_kcal"
"ë‹¹", "ë‹¹ë¥˜", "ë‹¹ë¶„" â†’ "sugar_g"
"ë‹¨ë°±ì§ˆ" â†’ "protein_g"
"ì¹´í˜ì¸" â†’ "caffeine_mg"
"ë‚˜íŠ¸ë¥¨", "ì—¼ë¶„", "ì†Œê¸ˆ" â†’ "sodium_mg"

# ì˜ì–‘ ë¹„êµ / ìˆœìœ„ ì§ˆì˜ ê·œì¹™
ì‚¬ìš©ìê°€ íŠ¹ì • ì˜ì–‘ì†Œì˜ "ê°€ì¥ ë†’ì€", "ê°€ì¥ ë‚®ì€", "ë§ì€", "ì ì€" ë“±ì˜ í‘œí˜„ì„ ì‚¬ìš©í•˜ë©´
intentëŠ” NutritionRanking ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

ì˜ˆ:
"ì¹´í˜ì¸ì´ ì œì¼ ë§ì€ ë©”ë‰´ëŠ”?"
"ë‹¹ë¥˜ ë‚®ì€ ìŒë£Œ ì•Œë ¤ì¤˜"
"ë‚˜íŠ¸ë¥¨ ì—†ëŠ” ìŒë£Œ ìˆì–´?"

slots:
- nutrient: ë¹„êµí•  ì„±ë¶„
  (calories_kcal, sugar_g, protein_g, caffeine_mg, sodium_mg ì¤‘ í•˜ë‚˜)
- compare: "max" ë˜ëŠ” "min"

/// ğŸ”¥ ìƒì„¸ì •ë³´ ìš”ì²­ ê·œì¹™ (NutritionQuery í™•ì¥)

/// ğŸ”¥ ìƒì„¸ì •ë³´ ìš”ì²­ ê·œì¹™ (NutritionQuery ê°•ì œ ì ìš©)

ì•„ë˜ í‘œí˜„ì´ ë¬¸ì¥ì— í¬í•¨ë˜ë©´ ë¬´ì¡°ê±´ NutritionQuery ë¡œ ë¶„ë¥˜í•œë‹¤:
- "ìƒì„¸ì •ë³´"
- "ìì„¸í•œ ì •ë³´"
- "ìƒì„¸ ì •ë³´"
- "ì •ë³´ ë³´ì—¬ì¤˜"
- "ì •ë³´ ë³´ì—¬ì£¼ì„¸ìš”"
- "ì •ë³´ ì•Œë ¤ì¤˜"
- "ì •ë³´ ì•Œë ¤ì£¼ì„¸ìš”"
- "ì˜ì–‘ì •ë³´"
- "ì˜ì–‘ ì •ë³´"
- "nutrition"
- "ì •ë³´ ì¢€"
- "ì„¤ëª…í•´ì¤˜"
- "ë³´ì—¬ì£¼ì„¸ìš”"

ì´ í‘œí˜„ë“¤ì´ í¬í•¨ë˜ê³ ,
ë©”ë‰´ ì´ë¦„ì´ í•¨ê»˜ ë“±ì¥í•˜ë©´:

â†’ intent = "NutritionQuery"
â†’ slots.menu_name = êµì •ëœ ë©”ë‰´ ì´ë¦„
â†’ slots.nutrient = null   // ì „ì²´ ì •ë³´ ìš”ì²­
â†’ response = "ì•„ë©”ë¦¬ì¹´ë…¸ì˜ ìƒì„¸ì •ë³´ì…ë‹ˆë‹¤." ê°™ì€ í•œ ë¬¸ì¥ ìƒì„±

ì˜ˆì‹œ:
"ì•„ë©”ë¦¬ì¹´ë…¸ ìƒì„¸ì •ë³´ ë³´ì—¬ì¤˜"
"ë¼ë–¼ ì˜ì–‘ì •ë³´ ì•Œë ¤ì¤˜"
"ì´ ë©”ë‰´ ìì„¸í•œ ì •ë³´ ì¢€"

â†’ intent = "NutritionQuery"
â†’ slots.menu_name = ì •í™•í•œ ë©”ë‰´ ì´ë¦„
â†’ slots.nutrient = null (ì „ì²´ ì •ë³´ ìš”ì²­)
â†’ response = "ì•„ë©”ë¦¬ì¹´ë…¸ì˜ ìƒì„¸ì •ë³´ì…ë‹ˆë‹¤." ì²˜ëŸ¼ í•œ ë¬¸ì¥ ìƒì„±

ë§Œì•½ ì‚¬ìš©ìê°€ "ì„¸ ì” ì£¼ì„¸ìš”", "ë‘ ì” ë”ìš”", "3ì”ìš”"ì²˜ëŸ¼
ë©”ë‰´ ì´ë¦„ ì—†ì´ ìˆ˜ëŸ‰ë§Œ ë§í•œ ê²½ìš°ì—ëŠ” menu_nameì„ nullë¡œ ë‘ê³ ,
intentëŠ” ë°˜ë“œì‹œ "AddItem"ì´ ì•„ë‹ˆë¼ "Unknown" ë˜ëŠ” "AskMenu"ë¡œ ì„¤ì •í•œë‹¤.

ì ˆëŒ€ menu_nameì„ None, ì„¸, ì” ë“±ì˜ ì´ìƒí•œ ê°’ìœ¼ë¡œ ë„£ì§€ ë§ ê²ƒ.


/// ğŸ”¥ ChangeCategory ê·œì¹™

ì‚¬ìš©ìê°€ ë©”ë‰´ ì¹´í…Œê³ ë¦¬ í™”ë©´ì„ ë³´ì—¬ë‹¬ë¼ê³  ìš”ì²­í•˜ë©´ intent="ChangeCategory" ë¡œ ë¶„ë¥˜í•œë‹¤.

ì˜ˆì‹œ í‘œí˜„:
- "ì»¤í”¼ í™”ë©´ ë³´ì—¬ì¤˜"
- "í‹° ì—ì´ë“œ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ê°€"
- "ë¹™ìˆ˜ ë©”ë‰´ ë³´ê³  ì‹¶ì–´"
- "ìŠ¤ë‚µ í™”ë©´ ë³´ì—¬ì£¼ì„¸ìš”"
- "ë¹µ ì¼€ì´í¬ ë©”ë‰´ ë³´ì—¬ì¤˜"

slots:
{
  "category": "ì •í™•í•œ ì¹´í…Œê³ ë¦¬ ì´ë¦„"
}

ì¹´í…Œê³ ë¦¬ëŠ” ì•„ë˜ ì¤‘ í•˜ë‚˜ë¡œ ì •ê·œí™”í•´ì„œ ë„£ëŠ”ë‹¤:
- "ì»¤í”¼"
- "í‹°/ì—ì´ë“œ"
- "ì£¼ìŠ¤/ë¼ë–¼"
- "ì‰ì´í¬/ìŠ¤ë¬´ë””"
- "ë¹™ìˆ˜/ì•„ì´ìŠ¤í¬ë¦¼"
- "ë¹µ/ì¼€ì´í¬"
- "ìŠ¤ë‚µ"

ìë™ êµì • ê·œì¹™ ì ìš©:
ì‚¬ìš©ìê°€ "ë¹™ìˆ˜", "ë¹™ìˆ˜ ì•„ì´ìŠ¤í¬ë¦¼", "ë¹™ìˆ˜/ì•„ì´ìŠ¤í¬ë¦¼", "ì–¼ìŒ ë©”ë‰´"ë¼ê³  ë§í•´ë„
slots.category ëŠ” "ë¹™ìˆ˜/ì•„ì´ìŠ¤í¬ë¦¼" ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

# ğŸ”¥ SmartRecommend ì¶”ì²œ ê·œì¹™ (ë³µìˆ˜ ì¡°ê±´ ì§€ì›)

ì‚¬ìš©ìê°€ ë¬¸ì¥ì—ì„œ ì¹¼ë¡œë¦¬, ë‹¹ë¥˜, ë‹¨ë°±ì§ˆ, ì¹´í˜ì¸, ë‚˜íŠ¸ë¥¨ ë“±ì˜ ì˜ì–‘ì†Œì™€
"ë†’ì€", "ë‚®ì€", "ë§ì€", "ì ì€", "ê°€ì¥", "ì œì¼" ë“±ì˜ ë¹„êµ í‘œí˜„ì„ í•¨ê»˜ ì‚¬ìš©í•˜ë©´
intent ëŠ” SmartRecommend ë¡œ ì„¤ì •í•œë‹¤.

ì˜ˆì‹œ:
- "ì¹´í˜ì¸ ë§ê³  ë‚˜íŠ¸ë¥¨ ì ì€ ë©”ë‰´ ì•Œë ¤ì¤˜"
- "ì¹¼ë¡œë¦¬ ë‚®ê³  ë‹¨ë°±ì§ˆ ë§ì€ ìŒë£Œ ì¶”ì²œí•´ì¤˜"
- "ì¹´í˜ì¸ ë†’ì€ìˆœìœ¼ë¡œ ì •ë ¬í•´ì¤˜"
- "ë‹¹ë¥˜ ë‚®ê³  ì¹¼ë¡œë¦¬ë„ ë‚®ì€ ë©”ë‰´ ë­ ìˆì–´?"

SmartRecommend ëŠ” ë°˜ë“œì‹œ filters ë°°ì—´ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

slots.filters í˜•ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:

{
  "filters": [
    { "nutrient": "caffeine_mg", "compare": "max" },
    { "nutrient": "sodium_mg",   "compare": "min" }
  ]
}

â–¶ nutrient ìë™ ë§¤í•‘ ê·œì¹™
"ì¹¼ë¡œë¦¬", "ì—´ëŸ‰" â†’ "calories_kcal"
"ë‹¹", "ë‹¹ë¥˜", "ë‹¹ë¶„" â†’ "sugar_g"
"ë‹¨ë°±ì§ˆ" â†’ "protein_g"
"ì¹´í˜ì¸" â†’ "caffeine_mg"
"ë‚˜íŠ¸ë¥¨", "ì†Œê¸ˆ", "ì—¼ë¶„" â†’ "sodium_mg"

â–¶ compare ë§¤í•‘ ê·œì¹™
"ë†’ì€", "ë§ì€", "í°", "ê°€ì¥ ë†’ì€", "ì œì¼ ë†’ì€", "ê°€ì¥ ë§ì€", "ì œì¼ ë§ì€"
    â†’ compare="max"

"ë‚®ì€", "ì ì€", "ì‘ì€", "ê°€ì¥ ë‚®ì€", "ì œì¼ ë‚®ì€", "ê°€ì¥ ì ì€", "ì œì¼ ì ì€"
    â†’ compare="min"

í•œ ë¬¸ì¥ ì•ˆì— ì—¬ëŸ¬ ì˜ì–‘ì†Œ ë¹„êµê°€ ë“¤ì–´ì˜¤ë©´ ëª¨ë‘ filters ë°°ì—´ì— ë„£ëŠ”ë‹¤.

ì˜ˆì‹œ:
"ì¹´í˜ì¸ ë§ê³  ë‚˜íŠ¸ë¥¨ ì ì€ ë©”ë‰´ ì¶”ì²œí•´ì¤˜"

â†’ AI ì¶œë ¥ JSON ì˜ˆì‹œëŠ” ë°˜ë“œì‹œ ë‹¤ìŒê³¼ ê°™ì•„ì•¼ í•œë‹¤:

{
  "intent": "SmartRecommend",
  "slots": {
    "filters": [
      { "nutrient": "caffeine_mg", "compare": "max" },
      { "nutrient": "sodium_mg",   "compare": "min" }
    ]
  },
  "response": "ìš”ì²­í•˜ì‹  ì¡°ê±´ìœ¼ë¡œ ì¶”ì²œí•´ë“œë¦´ê²Œìš”."
}

ì ˆëŒ€ ë‹¨ì¼ nutrient/compare êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
ë¬´ì¡°ê±´ filters ë°°ì—´ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.


# ğŸ”¥ AddToCart ê´€ë ¨ ê·œì¹™
- ì‚¬ìš©ìê°€ ì•„ë˜ í‘œí˜„ ì¤‘ í•˜ë‚˜ë¼ë„ ë§í•˜ë©´ AddToCart ë¡œ ë¶„ë¥˜í•´ì•¼ í•œë‹¤:
  "ë‹´ì•„", "ë‹´ì•„ì¤˜", "ë‹´ì•„ì£¼ì„¸ìš”", "ë‹´ê¸°", "ë‹´ì•„ì¤„ë˜", 
  "ë„£ì–´ì¤˜", "ë„£ì–´ì£¼ì„¸ìš”", "ë„£ì–´", "ë„¤ ë‹´ì„ê²Œìš”", 
  "ì‘ ë‹´ì•„ì¤˜", "ì˜¤ì¼€ì´ ë‹´ì•„", "ì¢‹ì•„ ë‹´ì•„", "í™•ì¸ ë‹´ì•„"
- AddToCart ì¼ ë•Œ slots ëŠ” ë¹„ì›Œë‘”ë‹¤: { }
- response ëŠ” "ì¥ë°”êµ¬ë‹ˆì— ë‹´ì„ê²Œìš”." ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“ ë‹¤.

ì˜ˆì‹œ:

"ì•ˆë…•í•˜ì„¸ìš”"
â†’ {
    "intent": "MenuQuery",
    "slots": {},
    "response": "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"
  }

"í‹° ì—ì´ë“œ í™”ë©´ ë³´ì—¬ì¤˜"
â†’ {
    "intent": "ChangeCategory",
    "slots": { "category": "í‹°/ì—ì´ë“œ" },
    "response": "í‹°/ì—ì´ë“œ í™”ë©´ìœ¼ë¡œ ì´ë™í• ê²Œìš”."
  }


"ì•„ë©”ë¦¬ì¹´ë…¸ í•˜ë‚˜"
â†’ {
    "intent": "BuildOrder",
    "slots": { "menu_name": "ì•„ë©”ë¦¬ì¹´ë…¸", "quantity": 1 },
    "response": "ì•„ë©”ë¦¬ì¹´ë…¸ í•œ ì” ë‹´ì•„ë“œë¦´ê²Œìš”."
  }

"ì•„ì´ìŠ¤ ë¼ì§€ ì•„ë©”ë¦¬ì¹´ë…¸ í•˜ë‚˜"
â†’ {
    "intent": "BuildOrder",
    "slots": {
      "menu_name": "ì•„ë©”ë¦¬ì¹´ë…¸",
      "quantity": 1,
      "temperature": "Iced",
      "size": "Large"
    },
    "response": "ì•„ì´ìŠ¤ ë¼ì§€ ì•„ë©”ë¦¬ì¹´ë…¸ í•œ ì” ë°”ë¡œ ë‹´ì•„ë“œë¦´ê²Œìš”."
  }

"ì•„ì´ìŠ¤ë¡œìš”"
â†’ {
    "intent": "OptionSelect",
    "slots": { "temperature": "Iced" },
    "response": "ì•„ì´ìŠ¤ë¡œ ì¤€ë¹„í• ê²Œìš”."
  }

"ëœ¨ê²ê²Œ"
â†’ {
    "intent": "OptionSelect",
    "slots": { "temperature": "Hot" },
    "response": "ëœ¨ê²ê²Œ ì¤€ë¹„í•˜ê² ìŠµë‹ˆë‹¤."
  }

"í° ê±¸ë¡œ"
â†’ {
    "intent": "OptionSelect",
    "slots": { "size": "Large" },
    "response": "Large ì‚¬ì´ì¦ˆë¡œ ì„ íƒí•˜ì…¨ì–´ìš”."
  }
"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_text}
        ],
        temperature=0
    )

    # â¬‡â¬‡â¬‡ JSON íŒŒì‹±
    try:
      raw = response.choices[0].message.content.strip()

      json_start = raw.find("{")
      json_end = raw.rfind("}") + 1
      clean_json = raw[json_start:json_end]

      result = json.loads(clean_json)

      if "slots" in result and "menu_name" in result["slots"]:
        mn = result["slots"]["menu_name"]
        corrected = normalize_menu_name(mn)
        if corrected:
          result["slots"]["menu_name"] = corrected
        return result
        

    except Exception as e:
        print("âŒ GPT JSON íŒŒì‹± ì‹¤íŒ¨:", e, raw)
        return {
            "intent": "Fallback",
            "slots": {},
            "response": "ì£„ì†¡í•´ìš”, ì˜ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”."
        }
    return result   # â¬…â¬…â¬…


def get_gpt_response_order(user_text: str):
    system_prompt = """
ë„ˆëŠ” ì£¼ë¬¸ í™•ì¸ í™”ë©´(order_voice)ì˜ ìŒì„± ëª…ë ¹ë§Œ ì²˜ë¦¬í•˜ëŠ” AIì•¼.

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•´:
{
  "intent": "...",
  "slots": { ... },
  "response": "..."
}

ì§€ì›í•˜ëŠ” intentëŠ” ë‹¤ìŒë§Œ ê°€ëŠ¥í•˜ë‹¤:
- ShowOrder
- RemoveItem
- AddItem
- Next
- Unknown

ê·œì¹™:

# 1) ì¥ë°”êµ¬ë‹ˆ í™•ì¸
ì‚¬ìš©ìê°€ "ë‚´ê°€ ë­ ì‹œì¼°ì–´", "ì¥ë°”êµ¬ë‹ˆ ë³´ì—¬ì¤˜", "ì§€ê¸ˆ ì£¼ë¬¸í•œ ê±° ë­ì•¼" ë“± â†’ ShowOrder

# 2) í•­ëª© ì‚­ì œ
"ì•„ë©”ë¦¬ì¹´ë…¸ ë¹¼ì¤˜", "ì¹´í˜ë¼ë–¼ ì‚­ì œ", "ìŠ¤ë¬´ë”” ì§€ì›Œì¤˜" ë“± â†’ RemoveItem
slots.menu_name í¬í•¨

# 3) ì¶”ê°€ ì£¼ë¬¸
"ì¶”ê°€ ì£¼ë¬¸", "ë” ì£¼ë¬¸í• ë˜", "ë’¤ë¡œ ê°€ê¸°", "ë©”ë‰´ë¡œ ëŒì•„ê°€ì¤˜" ë“± â†’ AddItem

# 4) ë‹¤ìŒ ë‹¨ê³„
"ë‹¤ìŒ", "ë„˜ì–´ê°€", "ê²°ì œí•˜ëŸ¬ ê°€ì" â†’ Next

# 5) ìœ„ì— í•´ë‹¹ë˜ì§€ ì•Šìœ¼ë©´ Unknown
"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_text}
        ],
        temperature=0
    )

    try:
        raw = response.choices[0].message.content.strip()
        json_start = raw.find("{")
        json_end = raw.rfind("}") + 1
        clean_json = raw[json_start:json_end]
        return json.loads(clean_json)
    except:
        return {
            "intent": "Unknown",
            "slots": {},
            "response": "ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”."
        }
def get_gpt_response_usage(user_text: str):
    system_prompt = """
ë„ˆëŠ” 'ì´ìš© ë°©ì‹ ì„ íƒ í™”ë©´(usage_voice)' ìŒì„± ì•ˆë‚´ AIì•¼.

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•´:
{
  "intent": "...",
  "response": "..."
}

ê°€ëŠ¥í•œ intent:
- EatHere
- TakeOut
- Unknown

ê·œì¹™:

# 1) ë¨¹ê³ ê°€ê¸° ì˜ë„(EatHere)
ë‹¤ìŒ í‘œí˜„ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ intent="EatHere":
- "ë¨¹ê³ "
- "ë§¤ì¥"
- "ë¨¹ê³ ê°ˆ"
- "ë¨¹ê³  ê°ˆ"
- "ë¨¹ê³  ê°€ìš”"
- "ë¨¹ê³  ê°€ëŠ”"
- "ì—¬ê¸°ì„œ"
- "ì—¬ê¸°ì„œ ë¨¹"

response ì˜ˆì‹œ:
"ë¨¹ê³  ê°€ì‹œëŠ”êµ°ìš”. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤."

# 2) í¬ì¥ ì˜ë„(TakeOut)
ë‹¤ìŒ í‘œí˜„ ì¤‘ í¬í•¨ë˜ë©´ intent="TakeOut":
- "í¬ì¥"
- "í…Œì´í¬ì•„ì›ƒ"
- "take out"
- "ê°€ì ¸ê°ˆ"
- "ê°€ì ¸ ê°ˆ"
- "ê°€ì§€ê³  ê°ˆ"
- "ê°–ê³  ê°ˆ"

response ì˜ˆì‹œ:
"í¬ì¥í•˜ì‹œëŠ”êµ°ìš”. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤."

# 3) ì¸ì‹ ë¶ˆê°€ (Unknown)
ê·¸ ì™¸ ë¬¸ì¥ì€ intent="Unknown"
response="ì´ìš© ë°©ì‹ì„ ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”."
"""

    reply = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_text}
        ],
        temperature=0
    )

    try:
        raw = reply.choices[0].message.content.strip()
        json_start = raw.find("{")
        json_end = raw.rfind("}") + 1
        return json.loads(raw[json_start:json_end])
    except:
        return {
            "intent": "Unknown",
            "response": "ì´ìš© ë°©ì‹ì„ ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”."
        }

def get_gpt_response_paychoice(user_text: str):
    system_prompt = """
ë„ˆëŠ” ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ í™”ë©´(paychoice_voice)ì˜ ìŒì„± ë„ìš°ë¯¸ì•¼.

ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ë‹µí•´:
{
  "intent": "...",
  "response": "..."
}

intentëŠ” ë‹¤ìŒë§Œ ì‚¬ìš©:
- Next
- Unknown

ì•„ë˜ ê²°ì œ ìˆ˜ë‹¨ ë‹¨ì–´ê°€ í¬í•¨ë˜ë©´ intent="Next":
- "ì¹´ë“œ"
- "ì¹´ë“œê²°ì œ"
- "í˜„ê¸ˆ"
- "í˜„ê¸ˆ ê²°ì œ"
- "ì¹´ì¹´ì˜¤"
- "ì¹´ì¹´ì˜¤í˜ì´"
- "í˜ì´ì½”"
- "ì œë¡œ"
- "ì œë¡œí˜ì´"
- "ë„¤ì´ë²„"
- "ë„¤ì´ë²„í˜ì´"

intent="Next" ì¼ ë•Œ response ì˜ˆì‹œ:
"ê²°ì œë¥¼ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤."

ê·¸ ì™¸ ë‹¨ì–´ëŠ” intent="Unknown"
"""

    reply = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_text}
        ],
        temperature=0
    )

    try:
        raw = reply.choices[0].message.content.strip()
        json_start = raw.find("{")
        json_end = raw.rfind("}") + 1
        return json.loads(raw[json_start:json_end])
    except:
        return {
            "intent": "Unknown",
            "response": "ê²°ì œ ìˆ˜ë‹¨ì„ ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”."
        }
